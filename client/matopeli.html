<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <link rel="stylesheet" type="text/css" href="/public/uistyle.css">
        <title>Matopeli</title>
	<script src="https://cdn.socket.io/socket.io-1.3.5.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

	<script type="text/javascript">
	    var socket = io();
	    var fps = 60;
	    var drawInfo={
	    		snake : [],
				direction : 2, //oikealle
				START_LENGTH : 8,
			    appleEaten : false,
			   	snakeAlive : false,
				score : 0,

				gameboardWidth : 65,
				gameboardHeight : 65,

				applePosRow :0, 
				applePosData:0
		}
		var enemySnake=[];
	    var receivedData;
	    var snakeInitialized = false;


	    socket.on("connect", function () {

		socket.name = "Anon";
		socket.on("chat message", function (msg, sender) {
		    console.log(msg);
		    $('#messages').prepend($('<li>').text(sender + "--->" + msg));
		});


		//käsitellään serveriltä tuleva käyttäjien listauspyyntö
		socket.on("listUsers", function (allUsers) {
		    $('#users').empty();
		    console.log("inside setInterval");
		    for (var i = 0; i < allUsers.length; i++) {
			console.log("Adding user to list" + allUsers[i]);
			$('#users').prepend($('<li>').text(allUsers[i]));
		    }
		    ;
		});

		//laittaa tietokannasta tulevan datan html-dokumenttiin
		socket.on("ShowRanking", function (data) {
		    $('#ranking').empty();
		    var ranking = JSON.parse(data);
		    for (i = 0; i < ranking.length; i++) {
			$('#ranking').prepend($('<li>').text(ranking[i].nickname + " " + ranking[i].maxpoints));
		    }
		});


		socket.on("initBoard",function(drawinfo){
			var gameboard = '<p id = score style="text-align:center">Score: </p>'
		    gameboard += '<table id="gameboard">'

			for(i = 0; i<drawinfo.gameboardHeight; i++){
				gameboard += '<tr>';
				for (j = 0; j < drawinfo.gameboardWidth; j++){
					var id = "r"+i+"d"+j;
					var grid = '<td id="'+id+'">';
					gameboard += grid;
				}
				gameboard += '</tr>';
			}
			gameboard += '</table>';
			gameboard += '<p style="text-align: center"> Ohjaa matoa nuolinäppäimillä. Kuoleman jälkeen paina R syntyäksesi uudelleen </P>';
			$("#gameboard_div").html(gameboard);
	    });

	    socket.on("sendInfoRestarted", function(data){
	    	//////MADON PIIRTÄMINEN/////////////
	    	console.log("Got the state");
	    	drawInfo = data.own;
	    	enemySnake = data.enemy.snake;
	    	drawSnakeAndApple();
			//////////////////////////////////////////
	    });

	    socket.on("sendState", function(data){	
	    	drawInfo = data.own;
	    	console.log(drawInfo.snake[0][0]);
	    	enemySnake = data.enemy.snake;
	    	console.log(enemySnake[0][0]);
	    });

	    function drawSnakeAndApple(){
		if(drawInfo.snakeAlive){
			setTimeout(function(){
				requestAnimationFrame(drawSnakeAndApple);
				//console.log("Drawing");
				$("#score").html("Score: " + drawInfo.score);
				//tehdään loop joka puhdistaa pöydän aina piirtämisen välissä, paitsi omenan kohdalta. Piirtää myös mustat reunat
				for(i = 0; i< drawInfo.gameboardHeight;i++){
					for(j=0;j<drawInfo.gameboardWidth;j++){
						var rowToClear = i;
						var dataToClear = j;
						if(rowToClear == 0 || rowToClear == drawInfo.gameboardHeight -1 || dataToClear == 0 || dataToClear == drawInfo.gameboardWidth -1){
							$("#r"+rowToClear+"d"+dataToClear).css("background", "black");
						}
						else{
						$("#r"+rowToClear+"d"+dataToClear).css("background", "lightblue");
						}
					}
				}
				//OMENAN PIIRTÄMINEN//
				$("#r"+drawInfo.applePosRow+"d"+drawInfo.applePosData).css("background", "red");
				//OMAN MADON PIIRTÄMINEN
				var length = drawInfo.snake.length;
				for(i=0; i < length;i++){
					var posrow = drawInfo.snake[i][0];
					var posdata = drawInfo.snake[i][1];
					$("#r"+posrow+"d"+posdata).css("background", "green");	
				}
				//VIHOLLISMAHDON PIIRTÄMINEN
				var enemyLength = enemySnake.length;
				for(i=0; i < enemyLength;i++){
					var posrow = enemySnake[i][0];
					var posdata = enemySnake[i][1];
					$("#r"+posrow+"d"+posdata).css("background", "black");	
				}
		},1000/fps);	
		} else{
			for(i = 0; i< drawInfo.gameboardHeight;i++){
			for(j=0;j<drawInfo.gameboardWidth;j++){
				var row = i;
				var data = j;
				
				$("#r"+row+"d"+data).css("background", "black");
					
			}
		}
		}
	} 

	    function sendMessage() {
		var message = document.getElementById('chatbox').value
		var sender = socket.name;
		socket.emit("chat message", message, sender);
	    }





	    var sentTime = 0;



	    //hakee ranking listan sivun latautuessa
	    function GetRanking() {
		socket.emit("getRanking");
	    }
	    
	    //ja 10 sekunnin välein
	    setInterval(function () {
		socket.emit("getRanking");
	    }, 10000);

	    document.onkeydown = checkKey;

function checkKey(e) {

    e = e || window.event;

    if (e.keyCode == '38') {
    	socket.emit("directionUp");
    }
    else if (e.keyCode == '40') {
    	socket.emit("directionDown");
    }
    else if (e.keyCode == '37') {
   		socket.emit("directionLeft");
    }
    else if (e.keyCode == '39') {
    	socket.emit("directionRight");
    }
    if (e.keyCode == '82') {
        socket.emit("restart");
        }
    }
});

	</script>
    </head>



    <body onload="GetRanking()">
        <div id="header">
            <h3 id="htitle">Login</h3>
	    Player: <input class="tbox" id="nick" type="text" name="player" >
	    <button onclick="login()">Login</button>

	    <p id = "userNickInfo" style="text-align:center; font-size:150%"> You are not signed in</p>
        </div>
        <script>
	    function login() {
		// Otetaan nick talteen nick-kentästä
		var nickname = $("#nick").val();
		//asetetaan socketin nimeks talteen otettu nickname
		socket.name = nickname;
		//lisätään socketin nimi serverillä olevaan listaan
		socket.emit("addMeToList", nickname);
		$('#userNickInfo').text("You are signed in as: " + socket.name);
		// Lähetetään serverille getissä käyttäjän ehdottama nickname
		$.get("/login?user=" + nickname, function (data) {
		});
	    }
        </script>

        <div id="leftmenu">
            <h4 id="ltitle">Online players</h4>
            <div id="usersPresent" style="height: 500px">
                <ul id="users">

                </ul>
            </div>
        </div>

        <div id="rightmenu">
            <h4 id="rtitle">TOP-30</h4>
            <ul id="ranking">

            </ul>
        </div>
        <div id="gameboard_div">

        </div>

        <div id="footer">
            <h4 id="ftitle">Messages</h4>
            <form id="chat">
                <div id="chat-area">
		    <ul id="messages">

		    </ul>
                </div>
                Send: <input id="chatbox" type="text" name="chatbox">
                <button type="button" onclick="sendMessage()">Send</button>
            </form>
        </div>
	<script src="https://code.jquery.com/jquery-2.1.4.js"></script>
	<!--<script src="/public/worm.js"></script> !-->
    </body>

</html>